# Odyssey CLI (`@okta/odyssey-cli`)

Internal CLI tools for the Odyssey repo. This package provides a collection of commands built with `yargs` to automate
common development tasks and enforce consistency across packages, particularly for internationalization (i18n) setup.

## Table of Contents

- [Usage](#usage)
- [i18n Commands](#i18n-commands)
  - [`i18n init`](#i18n-init)
  - [`i18n build:ts`](#i18n-buildts)
  - [`i18n generate`](#i18n-generate)
  - [`i18n generate:psuedoLocalProperties`](#i18n-generatepsuedolocaleproperties)
- [Contributing: Adding a New Command](#contributing-adding-a-new-command)

## Usage

This CLI is intended to be run from the root directory of a specific package within the monorepo. You can invoke it
using its binary name.

```bash
# General usage format
yarn odyssey-cli <command> [options]
```

To see a list of all available commands and options, you can use the --help flag.

```bash
yarn odyssey-cli --help
```

## i18n Commands

Below is a detailed list of the available commands and their options.

### `i18n init`

This command is the **primary setup tool** for adding internationalization (`i18n`) to a package. It is an **interactive wizard** that guides you through the process of configuring the translation pipeline, creating necessary files, installing tooling, and kicking off the final setup steps.

It is designed to be run once when a package first requires `i18n` support.

#### Steps Performed

This command automates the following steps:

1.  **Configuration Check:** Checks for existing configuration (`i18n.config.json` or `src/properties`) and prompts the user to overwrite if found.
2.  **Interactive Prompts:** Collects necessary details via the command line, including:

- Team name (with an autocomplete option by fetching available teams).
- GitHub reviewer alias.
- JIRA component, guardian and Slack channel (if manual details are required).

3.  **File Generation:**

- Creates the necessary `i18n.config.json` file with the collected information.
- Creates a base `<package-name>.properties` file in `src/properties` with a placeholder value.

4.  **Tooling Setup:** Installs the required contribution tooling package (`@okta/odyssey-contribution-tooling`) and runs the other `i18n` commands to complete setup:

5.  **JIRA Ticket Prompt:** Prompts the user to open a **JIRA ticket** for the UI Global Access team to register the new translation bundle.

#### Usage

This command takes no arguments. It determines configuration details interactively.

```bash
yarn odyssey-cli i18n init
```

### `i18n build:ts`

This command converts a `.properties` translation files into TypeScript modules.
It recursively searches a source directory for `.properties` files, parses them, and generates a corresponding `.ts`
file for each one in an output directory. Each generated file exports the translations as a `const` object.

By default, running the command in a package will read from `./src/properties` and write the generated `.ts` files to
`./src/properties/ts`.

This is the first step in our i18n pipeline.

```bash
yarn odyssey-cli i18n build:ts [options]
```

#### Options

- `--propertiesFilesPath`
  - Description: A relative path to the source directory containing .properties files.
  - Type: `string`
  - Default: `"src/properties"`
- `--tsModuleOutputPath`
  - Description: A relative path to the output directory where the TypeScript files will be generated.
  - Type: `string`
  - Default: `"src/properties/ts"`
- `--watch (-w)`
  - Description: Will watch for changes in the main `.properties` file and automatically re-generate the TypeScript modules on change.
  - Type: `boolean`
  - Default: `false`

### `i18n generate`

This command automates the creation of a fully typed `i18n` setup for the current package.
It reads the TypeScript translation modules (generated by the `build:ts` command) and generates a set of
standardized `i18n` files in the `src/i18n.generated` directory.

These generated files provide type-safety for translation keys, configure the i18n translation provider, and export
ready-to-use hooks and functions.

#### Generated Files

- `i18n.resources.ts`: Imports all translation modules and aggregates them into a single resources object.
- `i18n.types.ts`: Creates TypeScript types for all translation keys based on the default language file, ensuring type
  safety and enabling autocompletion.
- `i18n.ts`: Exports a pre-configured `i18n` instance, `Trans` component, `TranslationProvider` and `useTranslation`
  hook for the package.

#### Usage

```bash
yarn odyssey-cli i18n generate
```

### `i18n generate:psuedoLocaleProperties`

Small wrapper around the `@okta/tools.i18n.pseudo-loc` that generates the pseudo locale properties files.
Props provided after the `--` will be passed to the underlying `generate` command.

#### Usage

```bash
yarn odyssey-cli i18n generate:psuedoLocaleProperties
```

### Contributing: Adding a New Command

Adding new commands to the Odyssey CLI is straightforward. Follow the steps below to maintain the existing structure.

1. **Create the Command File**

   Create a new file for your command in the `src/commands/` directory. The file should be named after your command (
   e.g., `src/commands/myNewCommand.ts`).

2. **Define the Command Module**

   Inside your new file, define and export a `yargs` `CommandModule`. This object defines the command's name,
   description, options (builder), and logic (handler). Example, `src/commands/myNewCommand.ts`:

   ```typescript title="src/commands/myNewCommand.ts"
   import type { CommandModule } from "yargs";

   // Define the shape of your command's arguments
   export type MyNewCommandArgs = {
     myOption: string;
   };

   // The handler function contains your command's logic
   const whatMyNewCommandDoes = async (args: MyNewCommandArgs) => {
     console.log(`Executing my new command with option: ${args.myOption}`);
     // Your logic here...
   };

   // Export the command module
   export const myNewCommand: CommandModule<object, MyNewCommandArgs> = {
     command: "command:new",
     describe: "A description of what my new command does.",
     builder: (yargs) =>
       yargs.option("myOption", {
         describe: "Description for this option.",
         type: "string",
         default: "defaultValue",
       }),
     handler: myNewCommandHandler,
   };
   ```

3. **Export from Barrel File**

   Add an export for your new command in the barrel file at `src/commands/index.ts`.

   ```typescript
   export { i18nCommand } from "./i18n";
   export * from "./myNewCommand"; // Add this line
   ```

4. **Register the Command in the CLI**

   Finally, import your new command module in the main CLI entry point (`src/index.ts`) and register it with yargs.

   ```typescript
   import yargs from "yargs";
   import { hideBin } from "yargs/helpers";

   import {
     i18nCommand,
     myNewCommand, // 1. Import your command
   } from "./commands";

   yargs(hideBin(process.argv))
     .command(i18nCommand)
     .command(myNewCommand) // 2. Register it here
     .demandCommand(1, "You must provide a valid command.")
     .strict()
     .strictCommands()
     .help()
     .parseAsync()
     .catch(console.error);
   ```

5. **Add Tests**

   Remember to add corresponding tests in `cli-parser.node.test.ts` to ensure your command works as expected.
